{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block title %}Gerencia{% endblock %}
{% block content %}
  <div class="container fade-in py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="text-success fw-bold mb-0">
        <i class="fas fa-map me-3"></i>Distritos
      </h2>
    </div>
    <div class="card shadow-sm border-0 rounded-4">
      <div class="card-body">
        {% csrf_token %}
        <div class="table-container">
          <table class="beautiful-table" id="deptoTable" width="100%" cellspacing="0">
            <thead class="table-light">
              <tr>
                <th class="text-center">#</th>
                <th class="text-center">Departamento</th>
                <th class="text-center">C贸digo</th>
                <th class="text-center">Distrito</th>
                <th class="text-center">Colonias Asignadas</th>
                <th class="text-center">Acciones
                  <button class="btn btn-sm btn-primary bg-primary" title="Agregar Distrito" data-bs-toggle="modal" data-bs-target="#crearDistritoModal">
                    <i class="fas fa-plus"></i>
                    <i class="fas fa-map"> </i>
                  </button>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for dist in distritos %}
              <tr>
                <td class="text-center">{{ forloop.counter }}</td>
                <td class="text-center">
                  <strong>{{dist.departamento.codigo}}. </strong>
                  {{ dist.departamento.nombre }}
                </td>
                <td class="text-center">{{ dist.codigo }}</td>
                <td class="text-center">{{ dist.nombre }}</td>
                <td class="text-center">
                  <span class="badge {% if dist.colonias.count > 0 %}bg-primary{% else %}bg-secondary{% endif %} rounded-pill">
                    <i class="fas fa-city me-1"></i>
                    {{ dist.colonias.count }} colonia{{ dist.colonias.count|pluralize }}
                  </span>
                </td>

                <td class="text-center">
                  <!-- Bot贸n Editar -->
                  <button class="btn btn-warning btn-sm me-1 editar-distrito-btn"
                          data-id="{{ dist.id }}"
                          data-nombre="{{ dist.nombre }}"
                          data-codigo="{{ dist.codigo }}"
                          data-departamento="{{ dist.departamento.id }}"
                          data-bs-toggle="modal"
                          data-bs-target="#editarDistritoModal"
                          type="button">
                    <i class="fas fa-edit"></i>
                  </button>

                  <!-- Bot贸n Eliminar -->
                  {% if not dist.colonias.exists %}
                    <button class="btn btn-danger btn-sm eliminar-distrito-btn"
                            data-id="{{ dist.id }}"
                            data-nombre="{{ dist.nombre }}"
                            data-codigo="{{ dist.codigo }}"
                            data-departamento="{{ dist.departamento.nombre }}"
                            data-colonias="{{ dist.colonias.count }}"
                            data-bs-toggle="modal"
                            data-bs-target="#eliminarDistritoModal"
                            type="button">
                      <i class="fas fa-trash"></i>
                    </button>
                  {% else %}
                    <button class="btn btn-sm btn-outline-danger" 
                            title="No se puede eliminar un distrito con colonias asignadas" 
                            disabled
                            type="button">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  {% endif %}

                  <!-- Bot贸n Agregar Colonia -->
                  <button class="btn btn-sm btn-primary crear-colonia-btn"  
                          title="Agregar Colonia"
                          data-bs-toggle="modal"
                          data-bs-target="#crearColoniaDesdeDistritoModal"
                          data-id="{{ dist.id }}"
                          data-nombre="{{ dist.nombre }}"
                          type="button">
                    <i class="fas fa-plus"></i>
                    <i class="fas fa-tractor"></i>
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted">No hay Distritos registrados.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>  
  </div>

  <!-- Modales Distrito -->
  {% include 'includes/gerencia/modal/distritos/crear_distrito_modal.html' %}
  {% include 'includes/gerencia/modal/distritos/editar_distrito_modal.html' %}
  {% include 'includes/gerencia/modal/distritos/eliminar_distrito_modal.html' %}
  {% include 'includes/gerencia/modal/distritos/crear_colonia_desde_distrito_modal.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  //  DataTable
  const dataTable = new simpleDatatables.DataTable('#deptoTable', {
    perPage: 10,
    labels: { 
      placeholder: "Buscar...",
      perPage: "Registros por p谩gina",
      noRows: "No se encontraron Distritos registrados",
      info: "Mostrando {start} a {end} de {rows} Distritos"
    }
  });

  // ========================================
  // MODAL EDITAR DISTRITO
  // ========================================
  const modalEditar = document.getElementById('editarDistritoModal');
  
  // Usar delegaci贸n de eventos en el documento
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.editar-distrito-btn');
    if (btn) {
      console.log('Bot贸n editar clickeado', btn.dataset); // Debug
      
      const id = btn.dataset.id;
      const nombre = btn.dataset.nombre;
      const codigo = btn.dataset.codigo;
      const departamento = btn.dataset.departamento;

      document.getElementById('editar_distrito_id').value = id;
      document.getElementById('editar_nombre').value = nombre;
      document.getElementById('editar_codigo').value = codigo;
      document.getElementById('editar_departamento').value = departamento;

      // Limpiar errores previos
      const formEditar = document.getElementById('formEditarDistrito');
      formEditar.classList.remove('was-validated');
      document.querySelectorAll('[id^="error_editar_"]').forEach(el => {
        el.textContent = '';
        el.previousElementSibling?.classList.remove('is-invalid');
      });
      document.getElementById('alert_editar_error').classList.add('d-none');
    }
  });

  // ========================================
  // MODAL ELIMINAR DISTRITO
  // ========================================
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.eliminar-distrito-btn');
    if (btn) {
      console.log('Bot贸n eliminar clickeado', btn.dataset); // Debug
      
      const id = btn.dataset.id;
      const nombre = btn.dataset.nombre;
      const codigo = btn.dataset.codigo || 'N/A';
      const departamento = btn.dataset.departamento || 'N/A';
      const colonias = btn.dataset.colonias || 0;

      document.getElementById('eliminar_distrito_id').value = id;
      document.getElementById('eliminar_nombre_display').textContent = nombre;
      document.getElementById('eliminar_codigo_display').textContent = codigo;
      document.getElementById('eliminar_departamento_display').textContent = departamento;

      // Limpiar errores previos
      document.getElementById('alert_eliminar_error').classList.add('d-none');
      document.getElementById('alert_colonias_info').classList.add('d-none');

      const btnEliminar = document.getElementById('btnEliminarDistrito');
      
      // Mostrar info de colonias si las hay
      if (colonias && parseInt(colonias) > 0) {
        const alertColonias = document.getElementById('alert_colonias_info');
        document.getElementById('mensaje_colonias_info').textContent = 
          `Este distrito tiene ${colonias} colonia(s) asociada(s). No podr谩 eliminarse hasta que se reasignen.`;
        alertColonias.classList.remove('d-none');
        btnEliminar.disabled = true;
      } else {
        btnEliminar.disabled = false;
      }
    }
  });

  // ========================================
  // MODAL CREAR COLONIA DESDE DISTRITO
  // ========================================
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.crear-colonia-btn');
    if (btn) {
      console.log('Bot贸n crear colonia clickeado', btn.dataset); // Debug
      
      const distritoId = btn.dataset.id;
      const distritoNombre = btn.dataset.nombre;

      document.getElementById('distrito_asignado').value = distritoId;
      document.getElementById('info_distrito_nombre').textContent = distritoNombre;

      // Limpiar formulario
      const formColonia = document.getElementById('formCrearColoniaDistrito');
      formColonia.reset();
      formColonia.classList.remove('was-validated');
      document.getElementById('distrito_asignado').value = distritoId; // Restaurar despu茅s del reset
      document.getElementById('colonia_estado').value = 'activo';
      
      // Limpiar errores
      document.querySelectorAll('[id^="error_colonia_"]').forEach(el => {
        el.textContent = '';
        el.previousElementSibling?.classList.remove('is-invalid');
      });
      document.getElementById('alert_colonia_error').classList.add('d-none');
    }
  });

  // ========================================
  // LIMPIAR MODALES AL CERRAR
  // ========================================
  
  // Limpiar modal editar
  if (modalEditar) {
    modalEditar.addEventListener('hidden.bs.modal', function() {
      const formEditar = document.getElementById('formEditarDistrito');
      formEditar.reset();
      formEditar.classList.remove('was-validated');
      document.querySelectorAll('[id^="error_editar_"]').forEach(el => {
        el.textContent = '';
        el.previousElementSibling?.classList.remove('is-invalid');
      });
      document.getElementById('alert_editar_error').classList.add('d-none');
    });
  }

  // Limpiar modal eliminar
  const modalEliminar = document.getElementById('eliminarDistritoModal');
  if (modalEliminar) {
    modalEliminar.addEventListener('hidden.bs.modal', function() {
      const formEliminar = document.getElementById('formEliminarDistrito');
      formEliminar.reset();
      document.getElementById('alert_eliminar_error').classList.add('d-none');
      document.getElementById('alert_colonias_info').classList.add('d-none');
      document.getElementById('btnEliminarDistrito').disabled = false;
    });
  }

  // Limpiar modal crear colonia
  const modalColonia = document.getElementById('crearColoniaDesdeDistritoModal');
  if (modalColonia) {
    modalColonia.addEventListener('hidden.bs.modal', function() {
      const formColonia = document.getElementById('formCrearColoniaDistrito');
      formColonia.reset();
      formColonia.classList.remove('was-validated');
      document.querySelectorAll('[id^="error_colonia_"]').forEach(el => {
        el.textContent = '';
        el.previousElementSibling?.classList.remove('is-invalid');
      });
      document.getElementById('alert_colonia_error').classList.add('d-none');
    });
  }
});
</script>

{% endblock %}