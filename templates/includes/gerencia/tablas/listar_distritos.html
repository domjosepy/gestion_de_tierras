{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block title %}Gerencia{% endblock %}
{% block content %}
  <div class="container fade-in py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="text-success fw-bold mb-0">
        <i class="fas fa-map me-3"></i>Distritos
      </h2>
    </div>
    <div class="card shadow-sm border-0 rounded-4">
      <div class="card-body">
        {% csrf_token %}
        <div class="table-container">
          <table class="beautiful-table" id="TablaDistritos" width="100%" cellspacing="0">
            <thead class="table-light">
              <tr>
                <th class="text-center">#</th>
                <th class="text-center">Departamento</th>
                <th class="text-center">Código</th>
                <th class="text-center">Distrito</th>
                <th class="text-center">Colonias Asignadas</th>
                <th class="text-center">Acciones
                  <button class="btn btn-sm btn-primary bg-primary" title="Agregar Distrito" data-bs-toggle="modal" data-bs-target="#crearDistritoModal">
                    <i class="fas fa-plus"></i>
                    <i class="fas fa-map"> </i>
                  </button>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for dist in distritos %}
              <tr>
                <td class="text-center">{{ forloop.counter }}</td>
                <td class="text-center">
                  <strong>{{dist.departamento.codigo}}. </strong>
                  {{ dist.departamento.nombre }}
                </td>
                <td class="text-center">{{ dist.codigo }}</td>
                <td class="text-center">{{ dist.nombre }}</td>
                <td class="text-center">
                  <span class="badge {% if dist.colonias.count > 0 %}bg-primary{% else %}bg-secondary{% endif %} rounded-pill">
                    <i class="fas fa-city me-1"></i>
                    {{ dist.colonias.count }} colonia{{ dist.colonias.count|pluralize }}
                  </span>
                </td>

                <td class="text-center">
                  <!-- Botón Editar -->
                  <button class="btn btn-warning btn-sm me-1 editar-distrito-btn"
                          data-id="{{ dist.id }}"
                          data-nombre="{{ dist.nombre }}"
                          data-codigo="{{ dist.codigo }}"
                          data-departamento="{{ dist.departamento.id }}"
                          data-bs-toggle="modal"
                          data-bs-target="#editarDistritoModal"
                          type="button">
                    <i class="fas fa-edit"></i>
                  </button>

                  <!-- Botón Eliminar -->
                  {% if not dist.colonias.exists %}
                    <button class="btn btn-danger btn-sm eliminar-distrito-btn"
                            data-id="{{ dist.id }}"
                            data-nombre="{{ dist.nombre }}"
                            data-codigo="{{ dist.codigo }}"
                            data-departamento="{{ dist.departamento.nombre }}"
                            data-colonias="{{ dist.colonias.count }}"
                            data-bs-toggle="modal"
                            data-bs-target="#eliminarDistritoModal"
                            type="button">
                      <i class="fas fa-trash"></i>
                    </button>
                  {% else %}
                    <button class="btn btn-sm btn-outline-danger" 
                            title="No se puede eliminar un distrito con colonias asignadas" 
                            disabled
                            type="button">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  {% endif %}

                  <!-- Botón Agregar Colonia -->
                  <button class="btn btn-sm btn-primary crear-colonia-btn"  
                          title="Agregar Colonia"
                          data-bs-toggle="modal"
                          data-bs-target="#crearColoniaDesdeDistritoModal"
                          data-id="{{ dist.id }}"
                          data-nombre="{{ dist.nombre }}"
                          type="button">
                    <i class="fas fa-plus"></i>
                    <i class="fas fa-tractor"></i>
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted">No hay Distritos registrados.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>  
  </div>

  <!-- Modales Distrito -->
  {% include 'includes/gerencia/modal/distritos/crear_distrito_modal.html' %}
  {% include 'includes/gerencia/modal/distritos/editar_distrito_modal.html' %}
  {% include 'includes/gerencia/modal/distritos/eliminar_distrito_modal.html' %}
  {% include 'includes/gerencia/modal/distritos/crear_colonia_desde_distrito_modal.html' %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
      new simpleDatatables.DataTable('#TablaDistritos', {
          perPage: 10,
          labels: {
              placeholder: "Buscar...",
              perPage: "Registros por página",
              noRows: "No se encontraron Distritos registrados",
              info: "Mostrando {start} a {end} de {rows} Distritos"
          }
      });

  // ========================================
  // MODAL EDITAR DISTRITO
  // ========================================
  const modalEditar = document.getElementById('editarDistritoModal');
  
  // Usar delegación de eventos en el documento
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.editar-distrito-btn');
    if (btn) {
     // console.log('Botón editar clickeado', btn.dataset); // Debug
      
      const id = btn.dataset.id; 
      const nombre = btn.dataset.nombre;
      const codigo = btn.dataset.codigo;
      const departamento = btn.dataset.departamento;

      const inputId = document.getElementById('editar_distrito_id');
      const inputNombre = document.getElementById('editar_nombre');
      const inputCodigo = document.getElementById('editar_codigo');
      const selectDepartamento = document.getElementById('editar_departamento');

      if (inputId) inputId.value = id;
      if (inputNombre) inputNombre.value = nombre;
      if (inputCodigo) inputCodigo.value = codigo;
      if (selectDepartamento) selectDepartamento.value = departamento;

      // Limpiar errores previos
      const formEditar = document.getElementById('formEditarDistrito');
      if (formEditar) {
        formEditar.classList.remove('was-validated');
      }
      
      document.querySelectorAll('[id^="error_editar_"]').forEach(el => {
        el.textContent = '';
        const input = el.previousElementSibling;
        if (input) input.classList.remove('is-invalid');
      });
      
      const alertEditarError = document.getElementById('alert_editar_error');
      if (alertEditarError) {
        alertEditarError.classList.add('d-none');
      }
    }
  });

  // ========================================
  // MODAL ELIMINAR DISTRITO
  // ========================================
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.eliminar-distrito-btn');
    if (btn) {
     // console.log('Botón eliminar clickeado', btn.dataset); // Debug
      
      const id = btn.dataset.id;
      const nombre = btn.dataset.nombre;
      const codigo = btn.dataset.codigo || 'N/A';
      const departamento = btn.dataset.departamento || 'N/A';
      const colonias = btn.dataset.colonias || 0;

      const inputId = document.getElementById('eliminar_distrito_id');
      const displayNombre = document.getElementById('eliminar_nombre_display');
      const displayCodigo = document.getElementById('eliminar_codigo_display');
      const displayDepartamento = document.getElementById('eliminar_departamento_display');

      if (inputId) inputId.value = id;
      if (displayNombre) displayNombre.textContent = nombre;
      if (displayCodigo) displayCodigo.textContent = codigo;
      if (displayDepartamento) displayDepartamento.textContent = departamento;

      // Limpiar errores previos
      const alertEliminarError = document.getElementById('alert_eliminar_error');
      if (alertEliminarError) {
        alertEliminarError.classList.add('d-none');
      }
      
      const alertColoniasInfo = document.getElementById('alert_colonias_info');
      if (alertColoniasInfo) {
        alertColoniasInfo.classList.add('d-none');
      }

      const btnEliminar = document.getElementById('btnEliminarDistrito');
      
      // Mostrar info de colonias si las hay
      if (colonias && parseInt(colonias) > 0) {
        if (alertColoniasInfo) {
          const mensajeColonias = document.getElementById('mensaje_colonias_info');
          if (mensajeColonias) {
            mensajeColonias.textContent = `Este distrito tiene ${colonias} colonia(s) asociada(s). No podrá eliminarse hasta que se reasignen.`;
          }
          alertColoniasInfo.classList.remove('d-none');
        }
        if (btnEliminar) btnEliminar.disabled = true;
      } else {
        if (btnEliminar) btnEliminar.disabled = false;
      }
    }
  });

  // ========================================
  // MODAL CREAR COLONIA DESDE DISTRITO
  // ========================================
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.crear-colonia-btn');
    if (btn) {
      console.log('Botón crear colonia clickeado', btn.dataset); // Debug
      
      const distritoId = btn.dataset.id;
      const distritoNombre = btn.dataset.nombre;

      const inputDistrito = document.getElementById('distrito_asignado');
      const displayNombre = document.getElementById('info_distrito_nombre');

      if (inputDistrito) inputDistrito.value = distritoId;
      if (displayNombre) displayNombre.textContent = distritoNombre;

      // Limpiar formulario
      const formColonia = document.getElementById('formCrearColoniaDistrito');
      if (formColonia) {
        formColonia.reset();
        formColonia.classList.remove('was-validated');
        // Restaurar valores después del reset
        if (inputDistrito) inputDistrito.value = distritoId;
        const selectEstado = document.getElementById('colonia_estado');
        if (selectEstado) selectEstado.value = 'activo';
      }
      
      // Limpiar errores
      document.querySelectorAll('[id^="error_colonia_"]').forEach(el => {
        el.textContent = '';
        const input = el.previousElementSibling;
        if (input) input.classList.remove('is-invalid');
      });
      
      const alertColoniaError = document.getElementById('alert_colonia_error');
      if (alertColoniaError) {
        alertColoniaError.classList.add('d-none');
      }
    }
  });

  // ========================================
  // LIMPIAR MODALES AL CERRAR
  // ========================================
  
  // Limpiar modal editar
  if (modalEditar) {
    modalEditar.addEventListener('hidden.bs.modal', function() {
      const formEditar = document.getElementById('formEditarDistrito');
      if (formEditar) {
        formEditar.reset();
        formEditar.classList.remove('was-validated');
      }
      
      document.querySelectorAll('[id^="error_editar_"]').forEach(el => {
        el.textContent = '';
        const input = el.previousElementSibling;
        if (input) input.classList.remove('is-invalid');
      });
      
      const alertEditarError = document.getElementById('alert_editar_error');
      if (alertEditarError) {
        alertEditarError.classList.add('d-none');
      }
    });
  }

  // Limpiar modal eliminar
  const modalEliminar = document.getElementById('eliminarDistritoModal');
  if (modalEliminar) {
    modalEliminar.addEventListener('hidden.bs.modal', function() {
      const formEliminar = document.getElementById('formEliminarDistrito');
      if (formEliminar) {
        formEliminar.reset();
      }
      
      const alertEliminarError = document.getElementById('alert_eliminar_error');
      if (alertEliminarError) {
        alertEliminarError.classList.add('d-none');
      }
      
      const alertColoniasInfo = document.getElementById('alert_colonias_info');
      if (alertColoniasInfo) {
        alertColoniasInfo.classList.add('d-none');
      }
      
      const btnEliminar = document.getElementById('btnEliminarDistrito');
      if (btnEliminar) {
        btnEliminar.disabled = false;
      }
    });
  }

  // Limpiar modal crear colonia
  const modalColonia = document.getElementById('crearColoniaDesdeDistritoModal');
  if (modalColonia) {
    modalColonia.addEventListener('hidden.bs.modal', function() {
      const formColonia = document.getElementById('formCrearColoniaDistrito');
      if (formColonia) {
        formColonia.reset();
        formColonia.classList.remove('was-validated');
      }
      
      document.querySelectorAll('[id^="error_colonia_"]').forEach(el => {
        el.textContent = '';
        const input = el.previousElementSibling;
        if (input) input.classList.remove('is-invalid');
      });
      
      const alertColoniaError = document.getElementById('alert_colonia_error');
      if (alertColoniaError) {
        alertColoniaError.classList.add('d-none');
      }
    });
  }
});
</script>

{% endblock %}