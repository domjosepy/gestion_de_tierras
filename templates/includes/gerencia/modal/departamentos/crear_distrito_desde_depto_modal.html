<!-- Modal: Crear Distrito desde Departamento -->
<div class="modal fade modal-primary" id="crearDistritoDesdeDeptoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 border-0 shadow-lg">

      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="fas fa-plus-circle me-2"></i>Crear Distrito para: 
          <span class="fst-italic" id="depto_nombre_header"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form id="formCrearDistritoDesdeDepto" method="POST" action="{% url 'gerencia:crear_distrito' %}">
        {% csrf_token %}
        <input type="hidden" id="depto_id" name="departamento">

        <div class="modal-body">
          <!-- Código -->
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-hashtag me-1"></i>Código
            </label>
            <input type="number" class="form-control" id="distrito_codigo" 
                   name="codigo" min="1">
            <div class="invalid-feedback"></div>
          </div>

          <!-- Nombre -->
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-signature me-1"></i>Nombre del Distrito
            </label>
            <input type="text" class="form-control" id="distrito_nombre"
                   name="nombre" maxlength="200" minlength="3">
            <div class="invalid-feedback"></div>
          </div>
          
          <!-- Div para errores generales -->
          <div id="crearDistritoError" class="text-danger small mb-3"></div>
        </div>

        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-outline-warning" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cancelar
          </button>

          <button type="submit" class="btn btn-outline-success">
            <i class="fas fa-save me-1"></i>Crear Distrito
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const errorDiv = document.getElementById("crearDistritoError");

      function limpiarErrores(form) {
          form.querySelectorAll('.is-invalid').forEach(input => {
              input.classList.remove('is-invalid');
          });
          form.querySelectorAll('.invalid-feedback').forEach(div => {
              div.textContent = '';
          });
          errorDiv.textContent = '';
      }

      function manejarEnvioAJAX(form, modalID) {
          form.addEventListener('submit', function(e) {
              e.preventDefault();
              limpiarErrores(form);

              const formData = new FormData(form);
              const modal = document.getElementById(modalID);
              const btnSubmit = form.querySelector('button[type="submit"]');
              const oldText = btnSubmit.innerHTML;

              btnSubmit.disabled = true;
              btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';

              fetch(form.action, {
                  method: 'POST',
                  body: formData,
                  headers: {
                      'X-Requested-With': 'XMLHttpRequest',
                      'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                  }
              })
              .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        bootstrap.Modal.getInstance(modal).hide();
                        location.reload();
                    } else {
                        if (data.errors) {
                            // Mostrar errores por campo
                            for (const [field, messages] of Object.entries(data.errors)) {
                                const input = form.querySelector('[name="' + field + '"]');
                                const feedback = input ? input.nextElementSibling : null;
                                if (input && feedback) {
                                    input.classList.add('is-invalid');
                                    feedback.textContent = messages.join(' ');
                                }
                            }
                        } else if (data.message) {
                            errorDiv.textContent = data.message;
                        }
                    }
                })
                .catch(() => mostrarToast('error','Error al guardar'))
                .finally(() => {
                    btnSubmit.disabled = false;
                    btnSubmit.innerHTML = oldText;
              });
          });
      }

      const modal = document.getElementById('crearDistritoDesdeDeptoModal');
      const form = document.getElementById('formCrearDistritoDesdeDepto');

      modal.addEventListener('show.bs.modal', function(e) {
          const btn = e.relatedTarget;
          const deptoNombre = btn.dataset.nombre;
          
          document.getElementById('depto_id').value = btn.dataset.id;
          document.getElementById('depto_nombre_header').textContent = `${deptoNombre}`;
          document.getElementById('distrito_codigo').value = '';
          document.getElementById('distrito_nombre').value = '';
          
          limpiarErrores(form);
      });

      modal.addEventListener('hidden.bs.modal', () => {
          form.reset();
          limpiarErrores(form);
          form.classList.remove('was-validated');
      });

      manejarEnvioAJAX(form, 'crearDistritoDesdeDeptoModal');
  });
</script>