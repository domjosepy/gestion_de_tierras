<div class="modal fade modal-primary" id="crearDeptoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="crearDeptoForm" method="post" action="{% url 'gerencia:crear_departamento' %}">
        {% csrf_token %}
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fa-solid fa-plus-circle me-2"></i>Crear Departamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-hashtag me-1"></i>CÃ³digo</label>
            <input type="number" name="codigo" id="codigo" class="form-control" min="1">
            <div class="invalid-feedback"></div>
          </div>

          <div class="mb-3">
              <label class="form-label fw-bold">
                  <i class="fas fa-signature me-1"></i>Nombre
              </label>
              <input type="text" name="nombre" id="nombre" class="form-control" 
                    oninput="soloTexto(this)" 
                    minlength="3" title="El nombre debe tener al menos 3 caracteres">
              <div class="invalid-feedback"></div>
          </div>

          <div id="crearDeptoError" class="text-danger small mb-3"></div>
        </div>

        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-outline-warning" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cancelar</button>
          <button type="submit" class="btn btn-outline-success">
            <i class="fas fa-save me-1"></i>Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {  
    const form = document.getElementById("crearDeptoForm");
    const errorDiv = document.getElementById("crearDeptoError");

    function limpiarErrores(form) {
        form.querySelectorAll('.is-invalid').forEach(input => {
            input.classList.remove('is-invalid');
        });
        form.querySelectorAll('.invalid-feedback').forEach(div => {
            div.textContent = '';
        });
        errorDiv.textContent = '';
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        limpiarErrores(form);

        const btnSubmit = form.querySelector('button[type="submit"]');
        const oldText = btnSubmit.innerHTML;

        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';

        try {
            const res = await fetch(form.action, {
                method: "POST",
                headers: { "X-Requested-With": "XMLHttpRequest" },
                body: new FormData(form)
            });

            const data = await res.json();

            if (data.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById("crearDeptoModal"));
                modal.hide();
                form.reset();
                location.reload();
            } else {
                if (data.errors) {
                    // Mostrar errores por campo
                    for (const [field, messages] of Object.entries(data.errors)) {
                        const input = form.querySelector('[name="' + field + '"]');
                        const feedback = input ? input.nextElementSibling : null;
                        if (input && feedback) {
                            input.classList.add('is-invalid');
                            feedback.textContent = messages.join(' ');
                        }
                    }
                } else if (data.message) {
                    errorDiv.textContent = data.message;
                }
            }
        } catch (error) {
            console.error('Error:', error);
            errorDiv.textContent = 'Error al guardar. Intente nuevamente.';
        } finally {
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = oldText;
        }
    });

    // Limpiar errores cuando se cierre el modal
    const modal = document.getElementById('crearDeptoModal');
    modal.addEventListener('hidden.bs.modal', () => {
        form.reset();
        limpiarErrores(form);
    });
});
</script>