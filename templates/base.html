<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}SISTEMA DE REGULACION DE TIERRAS{% endblock %}</title>

    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- DataTables BS5 CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <!-- Simple-DataTables CSS y JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css">

    <!-- Nuestro nuevo CSS personalizado -->
    <link href="{% static 'css/admin5.css' %}" rel="stylesheet">
    <link href="{% static 'css/modal.css' %}" rel="stylesheet">
    
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
</head>

<body id="page-top">
    <div id="wrapper">
        {% include 'includes/sidebar.html' %}
        <div id="content-wrapper" class="d-flex flex-column">
            <div id="content">
                {% include 'includes/navbar.html' %}

                <div class="container-fluid">
                    <!-- Toasts Container -->
                    <div class="toast-container position-fixed end-0 mt-5 pt-2 pe-2" style="z-index: 1090; top: 60px;">
                        {% for message in messages %}
                        <div class="toast show align-items-center text-white bg-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}" 
                            role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                            <div class="d-flex">
                                <div class="toast-body">
                                    <i class="fas 
                                        {% if message.tags == 'success' %}fa-check-circle
                                        {% elif message.tags == 'error' %}fa-exclamation-circle
                                        {% elif message.tags == 'warning' %}fa-exclamation-triangle
                                        {% else %}fa-info-circle{% endif %} me-2"></i>
                                    {{ message }}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Contenido principal -->
                    <main class="fade-in">
                        {% block content %}{% endblock %}
                    </main>
                </div>
            </div>

            <footer class="sticky-footer mt-4">
                <div class="container my-auto">
                    <div class="text-center text-white my-auto">
                        <span>&copy; Sistema de Regulaci√≥n de Tierras</span>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Scripts en el orden CORRECTO para Bootstrap 5 -->
    <!-- jQuery 3.6 (solo necesario si usas DataTables u otros plugins que lo requieran) -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    
    <!-- Bootstrap 5 JS Bundle con Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- DataTables BS5 JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    

    <!-- Tu archivo de scripts -->
    <script src="{% static 'js/admin5.js' %}"></script>
    <script src="{% static 'js/tablas.js' %}"></script>

    {% block scripts %}{% endblock %}

    <!-- Inicializaci√≥n de Toasts (simplificado con BS5) -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.toast').forEach(el => {
            new bootstrap.Toast(el, { autohide: true, delay: 5000 }).show();
        });
    });
    
    function restoreSessionToast() {
        console.log('üîç restoreSessionToast() ejecut√°ndose...');
        try {
            const message = sessionStorage.getItem('toastMessage');
            const type = sessionStorage.getItem('toastType') || 'info';
            
            console.log('üì¶ Mensaje en sessionStorage:', message);
            console.log('üé® Tipo en sessionStorage:', type);
            
            if (!message) {
                console.log('‚ÑπÔ∏è No hay mensajes para restaurar');
                return;
            }

            const showToast = () => {
                console.log('üîÑ Intentando mostrar toast...');
                
                if (window.ToastManager && typeof window.ToastManager.create === 'function') {
                    console.log('‚úÖ ToastManager disponible');
                    const valid = ['primary','secondary','success','danger','warning','info','light','dark'];
                    const safeType = valid.includes(type) ? type : 'info';
                    window.ToastManager.create(message, safeType, { delay: 4000 });
                    sessionStorage.removeItem('toastMessage');
                    sessionStorage.removeItem('toastType');
                    console.log('üéâ Toast mostrado correctamente');
                } else {
                    console.warn('‚ö†Ô∏è ToastManager no disponible, usando fallback');
                    // Fallback con Bootstrap nativo
                    const toastContainer = document.querySelector('.toast-container') || document.body;
                    const toastEl = document.createElement('div');
                    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
                    toastEl.innerHTML = `
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                                    data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>`;
                    toastContainer.appendChild(toastEl);
                    
                    new bootstrap.Toast(toastEl, { delay: 4000 }).show();
                    sessionStorage.removeItem('toastMessage');
                    sessionStorage.removeItem('toastType');
                }
            };

            // Intentar m√∫ltiples veces por si ToastManager se carga despu√©s
            let attempts = 0;
            const tryShowToast = () => {
                attempts++;
                if (window.ToastManager && typeof window.ToastManager.create === 'function') {
                    showToast();
                } else if (attempts < 5) {
                    setTimeout(tryShowToast, 100);
                } else {
                    console.warn('‚ùå ToastManager no disponible despu√©s de 5 intentos');
                    // Fallback final
                    alert(message);
                    sessionStorage.removeItem('toastMessage');
                    sessionStorage.removeItem('toastType');
                }
            };

            tryShowToast();
            
        } catch (e) {
            console.error('[ToastRestore] Error restaurando toast', e);
        }
    }
    
    window.addEventListener('load', restoreSessionToast);

    console.log('üîÑ Verificando ToastManager...');
    console.log('ToastManager disponible:', typeof window.ToastManager);
    console.log('ToastManager.create disponible:', window.ToastManager && typeof window.ToastManager.create);
    
    // Verificar despu√©s de un delay
    setTimeout(() => {
        console.log('üîÑ Verificaci√≥n delay - ToastManager:', typeof window.ToastManager);
    }, 1000);
</script>
</body>
</html>